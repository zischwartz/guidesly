{%extends "base.html" %}

{%block title%}Edit Card{%endblock%}

{%block extrahead%}

		<link rel="stylesheet" media="all" href="{{STATIC_URL}}upload-plugin/jquery.fileupload-ui.css"/>
		<script type="text/javascript" src="{{STATIC_URL}}upload-plugin/jquery.iframe-transport.js"></script>
		<script type="text/javascript" src="{{STATIC_URL}}upload-plugin/jquery.fileupload.js"></script>
		<script type="text/javascript" src="{{STATIC_URL}}upload-plugin/jquery.fileupload-ui.js"></script>
		<link rel="stylesheet" href="{{STATIC_URL}}upload-plugin/thumbnail-scaling.css">
		

		
		<script type="text/javascript" src="{{STATIC_URL}}js-libs/Markdown.Converter.js"></script> 
	    <script type="text/javascript" src="{{STATIC_URL}}js-libs/Markdown.Sanitizer.js"></script> 
	    <script type="text/javascript" src="{{STATIC_URL}}js-libs/Markdown.Editor.js"></script>
	
	
	 	 {# // <script type="text/javascript" src="http://feather.aviary.com/js/feather.js"></script> #}
		
		
		{# <link rel="stylesheet" href="{{STATIC_URL}}create/card.css"> #}
		// <script src="{{STATIC_URL}}create/card.js"></script>
		
		
		<script type="text/javascript">
			var current_card_id ="{{card.id}}";
			var guide_id = {{card.guide.id}};
			var initial_card_json= '{{card_json|safe|escapejs}}';
			var all_cards = '{{all_cards_json|safe|escapejs}}'; 
			var primary_media_json = '{{primary_media_json|safe|escapejs}}'; 
			// TODO replace with all_cards with guide
			
			//     Aviary 
			// requires: http://feather.aviary.com/js/feather.js
			
			// var featherEditor = new Aviary.Feather({
			// 	openType: 'lightbox', // or 'float' and add something to set off the image being edited
			// 	theme: 'black',
			// 	apiKey: 'f64d09c9c2b5ea52e4c167b4264e4344',
			// 	// tools: ['rotate', 'flip', 'resize'],
			// 	onSave: function(imageID, newURL) {
			// 		var img = document.getElementById(imageID);
			// 		img.src = newURL;
			// 		featherEditor.close();
			// 		the_element_ko = ko.utils.arrayFirst(VM.mediaelements(), function(item) { return (item.client_id()+ 'img') === imageID;})
			// 		the_element_ko.external_file(newURL)
			// 	},
			// }); //end aviary inialization
			
								
		$(document).ready(function(){	
			
			
			var converter = Markdown.getSanitizingConverter();
			var editor = new Markdown.Editor(converter);
			editor.run();
			
			$(".adder .closer").click(function(event){
				adder= $(this).parent();
				adder.addClass("minimized").removeClass('editing');
				event.stopPropagation();
				if (adder.hasClass('title'))
					VM.title('');
				return (false);
			});
			
			$(".modal a.closer").click(function(event){
				$(this).parents('.modal-backdrop').fadeOut('fast');
				// adder.addClass("minimized").removeClass('editing');
				// event.stopPropagation();

				return (false);
			});

			$(".adder.minimized").live('click', function(){
				$(this).removeClass('minimized');
			});
				
			
		}); //end docready

	function didPressEnter(event)
	{if ( event.which == 13 )
			{
				turnOffEditing(event);
			}
		return (true);}

	function turnOnEditing(event)
	{	
		console.log('turnOnEditing');
		el=$(event.currentTarget);
		el.addClass('editing');
		el.find("textarea:first").focus();
		el.find("input:first").focus();
		event.stopPropagation();
		return false;
	}
	
	function turnOffEditing(event)
	{
		el=$(event.target);
		// console.log(el.hasClass('editing'));
		if (el.hasClass('editing'))
		{
			event.stopPropagation();
			return false;
		}
		$(el).removeClass('editing');
		$(el).parents('.editing').removeClass('editing');
		event.stopPropagation();
		
		VM.save_card();
	}
	
	
			
</script>
{%endblock%}

{%block header%}

<li class="menu"> 
  <a href="#" class="menu active">{{card.guide.title}}</a> 
  <ul class="menu-dropdown"> 
    <li><a href="{% url EditGuide gslug=card.guide.slug %}">Overview of {{card.guide.title}}</a></li> 
    <li><a href="{% url EditGuide gslug=card.guide.slug %}">Guide Options</a></li> 
    <li><a href="{% url BuildCard gslug=card.guide.slug %}">Add a New Card</a></li> 
    <li class="divider"></li> 
    <li><a href="#">Publish</a></li> 
  </ul> 
</li> 
<li><a target="_blank" href="{% url CardDetailViewByIdRedirect id=card.id %}">Preview <span data-bind="text: !title()  ? 'This Card': title"></span></a></li> 


{%endblock%}

{%load verbatim_templatetag%} 

{%block content%}
<div class="cardwrap"> 
	<div class="card">

		<div class="title adder " tabindex="3" data-bind="event:{ focusin: turnOnEditing, focusout: turnOffEditing, keypress: didPressEnter}">

			<a class="closex closer" href="#">x</a>				
			<div class="adder_inner">
				<h1 data-bind="text: !title()  ? 'Clever Title Here': title, css: { notBlank: title() }"></h1>
				<input id="title" name="card_title" type="text" class="tinput"  data-bind="value:title, valueUpdate: 'afterkeydown'">
				<button class="btn tiny smallOK" id="titleOK" data-bind="click: turnOffEditing, clickBubble: false">OK</button>

			</div>
		</div>
		
		<div id="media"  > {# class="files" #} {# upload-template #}
			<div data-bind="template:{name: 'mediaTemplate',  foreach: VM.mediaelements}"></div>
		</div> {# /#media elements #}
		
		<div class="adder media" data-bind="css:{minimized: VM.mediaelements().length}" >
			<a class="closex closer" href="#">x</a>
			<div class="adder_inner">
				<div class="addertop">
					<h2>Add <br class="SoM"> Media</h2>
					{# <h2>Add <span data-bind="text:media_type" style="text-transform: capitalize;"></span> </h2> #}{# <img src="{{STATIC_URL}}img/image-icon.png" data-media_type="image" class=" icon" data-bind="event: {mouseover: changeMediaType, mouseout: changeMediaTypeBack}"><img src="{{STATIC_URL}}img/video-icon.png" data-media_type="video" class=" icon" data-bind="event: {mouseover: changeMediaType, mouseout: changeMediaTypeBack}"><img src="{{STATIC_URL}}img/audio-icon.png" data-media_type="audio" class=" icon" data-bind="event: {mouseover: changeMediaType, mouseout: changeMediaTypeBack}"><img src="{{STATIC_URL}}img/upload-icon.png" data-media_type="whatever" class=" icon" data-bind="event: {mouseover: changeMediaType, mouseout: changeMediaTypeBack}"> #}
				</div>
				<div class="sub_add">
					<div class="left_wrap">
					 <h4>From your computer</h4>
					{%include 'create/fileupload.html'%}
					<p><strong class="green">Drag files here</strong> <span class="HoM">from your computer </span> . <span class="HoM"><br>In a modern browser, it's that easy.</p></span>
					</div>
				</div>
				<div class="sub_add">
					<h4>From the web</h4>
					<button class="btn large" data-bind="click: function(){$('#addExternalMediaModal').fadeIn()}">Youtube, Flickr, Etc.</button><p><strong>Coming soon</strong><br></p>
				</div>
				{# <div class="sub_bottom"> #}{# 	<h4>From Your Files</h4> <p clas="HoM">Well, you don't have any yet. But we wanted to let you know that they're reusable.<br> #}{# </div> #}
			</div> <!-- /adder_inner -->
		</div><!-- end adder media -->



		<div class="adder text" tabindex="5" data-bind="event: { focusin: turnOnEditing, focusout: turnOffEditing}">
			<a class="closex closer" href="#">x</a>
			<div class="adder_inner">
				 <div class="cardtext" data-bind="visible: !text()"><p>Text for your card. Easy formatting. Totally optional.</p></div>
				 <div id="wmd-preview" class="wmd-panel wmd-preview cardtext" data-bind="visible: text()">Placeholder</div>

	              <form class="wmd-panel"><div id="wmd-button-bar"></div> 
					<textarea data-bind="value:text, valueUpdate: 'afterkeydown'" class="xxlarge tinput wmd-input" id="wmd-input" name="textarea" placeholder="Add some text here. You know, if you want to..."></textarea> </form>
					<button class="btn tiny smallOK" id="card_textOK" data-bind="click: function(event){turnOffEditing(event), VM.save_card()}">OK</button>
			</div>
		</div>
		
		<div class="adder input">
			<a class="closex closer" href="#">x</a>
			<div class="adder_inner">
				<h2>Add an Interaction</h2>
				<span class="HoM">Move your users to different cards using these interactions<br></span>
				<button class="btn large " data-input_type="button" data-input_verb="add" data-bind="click: showInputModal">Add Button</button>
				<button class="btn large" data-input_type="map" data-input_verb="add" data-bind="click: showInputModal">Add Map</button>
				<button class="btn large" data-input_type="timer" data-input_verb="add" data-bind="click: showInputModal">Add Timer</button>
			</div>
		</div> <!-- /adder input -->
		

			<div id="prev_and_next" class="prev_and_next" data-bind="visible: !(is_floating_card())">
				<br>
				{%if prev_card%}<div class="input_element prev"> <a class="input-button" href="{%url EditCard gslug=prev_card.guide.slug id=prev_card.id  %}">Previous</a> </div>{%endif%}
				{%if next_card%}<div class="input_element next"><a class= "input-button" href="{%url EditCard gslug=next_card.guide.slug id=next_card.id  %}">Next</a></div>{%endif%}
			</div>

		
	</div> <!-- /card --> 
</div> <!-- /cardwrap -->

{# end new #}
{# 	********************************************************************************************************************************************************************************** #}
{# 	********************************************************************************************************************************************************************************** #}
{# 	********************************************************************************************************************************************************************************** #}
{# 	********************************************************************************************************************************************************************************** #}
{# 	********************************************************************************************************************************************************************************** #}
{# 	********************************************************************************************************************************************************************************** #}


		<div id="card_being_edited" class="{%if s.brand_new%}brand_new{%endif%}">
			

	
	{# INPUT ELEMENTS #}
		<div data-bind="template:{name: VM.inputTypeTemplate,  foreach: VM.inputelements,

		 				beforeRemove: function(elem) {$(elem).slideUp() },
						afterAdd: function(elem) {$(elem).hide().slideDown() }}"> </div>


		<div data-bind="template:{name: VM.inputTypeTemplate,  foreach: VM.mapelements,

		 				beforeRemove: function(elem) {$(elem).slideUp() },
						afterAdd: function(elem) {$(elem).hide().slideDown() }}"> </div>
	
	
		{# Prev and Next Buttons for linear guides #}

		<div class="F">F</div>

	</div> {# end #card_being_edited  ------------------------ #}


	


</form> {# end card form #}



{%endblock%}


{%block sidebar%}




				{#  #}
				{# <input type="radio" id="checkb-is_primary-${id}" class="uibutton" data-bind="checked: VM.primary_media" value="${resource_uri}" name="primary_media" /> #}
				{# <label for="checkb-is_primary-${id}">Primary Media</label> #}
				
				{# for input template debugging       <input data-bind="value: default_action.goto">    #}
<div class="sidebar">
	<h3>Card Options</h3>
	<a href="{% url CardDetailViewByIdRedirect id=card.id %}" class="btn primary">Preview Card</a>
	<button class="btn primary" data-bind="click: VM.save_card">Save Card</button>
	<form class="form-stacked">
		<div class="clearfix">
		            <label for="xlInput">Card Slug</label><div class="input"><input class="large"  name="slug" size="30" type="text"><span class="help-block">A slug? Ew!</span></div></div>
					<div class="clearfix">
					            <label id="optionsCheckboxes">Card Options</label>
					            <div class="input">
					              <ul class="inputs-list">
					                <li>
					                  <label>
										<input type="checkbox" data-bind="checked: is_floating_card" id="is_floating_card">
					                    <span>This is a sidecard</span>
					                  </label>
										<span class="help-block">Side cards are outside the normal flow of the guide. Basically, this means they don't have previous and next buttons.
					                </li>
					                <br>
									<li>
					                  <label>
					                    <input type="checkbox" name="optionsCheckboxes" value="option2" disabled>
					                    <span>Autoplay Video and Audio </span>
					                  </label>
					                </li>
									<li>
					                  <label>
					                    <input type="checkbox" name="primary_is_bg" value="primary_is_bg" data-bind="checked: primary_is_bg">
					                    <span>Make the main image the card background </span>
					                  </label>
					                </li>
									<li>
					                  <label>
					                    <input type="checkbox" name="optionsCheckboxes" value="option2" >
					                    <span>Give Images Shadows</span>
					                  </label>
					                </li>
					              </ul>
					            </div>
					          </div>			
	</form>

	<p>Lorem ipsum dolor sit amet, <a href="#">consectetur adipisicing</a> elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam.</p>
	<button class="btn danger">Delete Card</button>	
</div> {# /sidebar #}



	{# NEW #}
	{# <img class="preview_image" data-bind="attr: { id: (client_id() + 'img'), src: medium_url }"/> #}
{# template-upload #} {# /x-jquery-tmpl #}
{% verbatim %}

 	<script id="mediaTemplate" type="text/html">	
	
		<div class="mediaTemplate" id="${client_id}" data-bind="attr: { id:  client_id}, css: {primary_media: VM.check_if_primary($item.data), not_primary_media: !(VM.check_if_primary($item.data))}">
			<div class="preview">
				<img class="preview_image" data-bind="attr: { id: (client_id() + 'img'), src: medium_url }"/>
			</div>
			<div class="mediaOptions">
				<div class="uploading_indicator"> Uploading <br><img src="/static/img/ajax-loader.gif"></div> <br>
				
				{{ if VM.check_if_primary($item.data) }}
					<label class="capitalized"><span data-bind="text: type"></span> title (optional) <input type="text" data-bind="value: title, valueUpdate: 'afterkeydown'"><br>
					<button class="btn" data-bind="click: VM.editImage">Edit Image</button>
				 	<button class="btn danger" data-bind="click: VM.deleteFromCard"> Remove </button><br><br>
					<button class="btn tiny" data-bind="click: VM.save_element">OK</button>
					<button class="btn tiny">Cancel</button>
				{{else}}
					<button  class="btn primary" data-bind="click: VM.makePrimary">Edit/Make Main</button>
					<button class="btn danger small" data-bind="click: VM.deleteFromCard"> Remove </button><br><br>
				 	
				{{/if}}
				
			</div>
			<div class="mediaTitle" data-bind="text: title, visible: title"></div>
		</div>
	</script>
	

	

	
	<!-- In betweeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeennnnnnnnnnnnnnnnnnnnnnnnnnnnn --> 
	
	
	<script id='buttonTemplate' type='text/html'>
		<div class="input_element">
			<a data-bind="text:button_text, click: VM.showInputModal" data-input_type="button" data-input_verb="edit" ></a>
			</div>
			
		</div>
	</script>	
	{% endverbatim %}

	
	{# OLD #}

	{% verbatim %}
	
	<script id='mapTemplate' type='text/html'>
		<div class="ue" data-bind="event: { focusin: VM.flipEl, focusout: VM.unflipEl }, attr: { tabindex: typeof(id)!='undefined' ? id: -1 }">
			<figure class="front">
				<div class="media_holder" style="background-image: url('/static/img/map-icon.png')"></div>
				<div class="front input-button" data-bind="text: title"></div>
			</figure>
			
			<div class="back">
			
			<div class="clearfix"></div>
			<a class="uibutton delete" data-bind="click: VM.deleteFromCard">Remove</a>
			
			</div>
		</div> 
	</script>



	<script id='timerTemplate' type='text/html'>
		<div class="ue" data-bind="event: { focusin: VM.flipEl, focusout: VM.unflipEl }, attr: { tabindex: typeof(id)!='undefined' ? id: -1 }">
			<div class="front input-button"><span data-bind="text:button_text"></span> <br><span data-bind="text:minutes"></span>:<span data-bind="text:seconds"></span></div>
			
			<div class="back">
			<input class="button_text" data-bind="value:button_text">
			<input class="button_text" data-bind="value:minutes">
			<input class="button_text" data-bind="value:seconds">

			<a class="uibutton delete" data-bind="click: VM.deleteFromCard">Remove</a>

			</div>
			
		</div>
	</script>

		
	
	<script id='errorNoTemplate' type='text/html'>
		<div class="smallcard"> 
		ERROR NO TEMPLATE. You gota have one....
		
		<div class="clearfix"></div>
		<a class="uibutton delete" data-bind="click: VM.deleteFromCard">Remove</a>
			
		</div>
	</script>
	
{%endverbatim%}

<div class="modal-backdrop" id="addExternalMediaModal">
	<div class="modal">
		<div class="modal-header">
			<h3>Add Media From The Web</h3>
			<a href="#" class="close closer" >×</a>
		</div>
		<div class="modal-body">
			<p>Copy and paste the web address of your image, or video below. </p>
			<p>For images, you want thing that ends in .jpg, .png or something similar.</p>
			<p>For video, we currently only support youtube. Just give us the url of the video page</p>
			<div class="alert-message error"><p><strong>Not Yet! </strong> Sorry, we haven't implemented this feature yet.</p></div>
			<input id="external_file_url" name="external_file_url" type="text" class="tinput" size="30" placeholder="http://">
			
		</div>
		<div class="modal-footer">
			<a href="#" class="btn primary" >Add!</a>
			<a href="#" class="btn secondary closer">Cancel</a>
		</div>
	</div> 
</div> {# /#addExternalMediaModal #}


{# INTERACTION MODAL #}
{# INTERACTION MODAL #}
{# INTERACTION MODAL #}
<div class="modal-backdrop" id="inputModal">
	<div class="modal">
		<div class="modal-header">
			<h3 class="capitalized"><span data-bind= "text: VM.current_input_verb"></span> <span data-bind= "text: VM.InputVM().type"></span></h3>
			<a href="#" class="close closer">×</a>
		</div>
		<div class="modal-body">
			
			
			{# It's a Button!  #}
			<div class="button_properties" data-bind="visible: VM.InputVM().type()=='button' ">
				<label for="adder_button_text">Button Label:</label>
				<input class="tinput" type="text" name="" placeholder="Do Something" id="adder_button_text" data-bind="value:VM.InputVM().button_text,  valueUpdate: 'afterkeydown'"><br>
 			</div>
			
			{# It's a Timer!  #}
			<div class="timer_properties" data-bind="visible: VM.InputVM().type()=='timer' ">	
				<div class="alert-message error"><p><strong>Not Yet! </strong> Sorry, we haven't implemented this feature yet.</p></div>
				
				<label for="adder_timer_text">Timer Label:</label>	<input id="adder_timer_text" type="text" data-bind="value:VM.InputVM().button_text, valueUpdate: 'afterkeydown'" placeholder="Do something sometime"><br>
				<label for="timer_seconds">Seconds : </label><input id="timer_seconds" type="number" step="1" min="0" max="60" value="0" data-bind="value: VM.InputVM().seconds, valueUpdate: 'afterkeydown' ">
				<label for="timer_minutes">Minutes : </label><input id="timer_minutes" type="number" step="1" min="0" max="60" value="0" data-bind="value: VM.InputVM().minutes, valueUpdate: 'afterkeydown' ">
				Go to a card? Or just get attention.
			</div> {# end timer properties #}
			
			{# It's a map! #}
			<div class="map_properties" data-bind="visible: VM.InputVM().type()=='map' ">	
				<div class="alert-message error"><p><strong>Not Yet! </strong> Sorry, we haven't implemented this feature yet.</p></div>
				{# <form data-bind="submit:addMap2Card"> #}
				<input type="submit" value="Add Map">
				</form>
			</div> {# end map properties, this one will be different, user will add map, map will pop up, then points will be edited with this... #}
			
			
			{# Action below. Pick one for your input to trigger. #}
			<div class="action_properties" data-bind="visible: VM.InputVM().button_text">
				<p>Now, pick a card for the <span data-bind="text:VM.InputVM().type"></span> to go to:</p>

				{# For each card... #}
				<div class="all_card_holder" data-bind="template: {name: 'smallCardTemplate',
				  						foreach: VM.all_cards,
						 				beforeRemove: function(elem) {$(elem).slideUp() },
										afterAdd: function(elem) {$(elem).hide().slideDown() } }">
				</div>
				
				{# The template #}
				{%verbatim%}
				<script id='smallCardTemplate' type='text/html'>
					<label class="btn cardbtn" for="radiob-card-${id}" data-bind="css: {checked: VM.InputVM().default_action.goto()==resource_uri}, click: function() { VM.InputVM().default_action.goto(resource_uri); return true; } ">
						<span data-bind="text: title ? title.slice(0,15): 'Untitled'"></span> 
						<input type="radio" id="radiob-card-${id}" data-bind="value: resource_uri, checked:  VM.InputVM().default_action.goto" name="pickacard">
							{{if primary_media }}<br><img src="${primary_media}">{{/if}}
						</label>
				</script>
				{%endverbatim%}
				
				{# *************************** #}
				<br><br>
					<label class="btn cardbtn" for="radiob-card-new" data-bind="css: {checked: VM.InputVM().default_action.goto()=='addcard'}"> <span data-bind="text: !newCardTitle() ? 'An Entirely New Card' : newCardTitle "></span>
						<input type="radio" id="radiob-card-new" data-bind="checked: VM.InputVM().default_action.goto" value="addcard" name="pickacard"/>
					</label> 
					<br><input type="text" data-bind="value: newCardTitle, visible: VM.InputVM().default_action.goto()=='addcard', valueUpdate: 'afterkeydown' " placeholder="New Card Title">
			</div> {#end action properties#}	
			<div class="clearfix"></div>
				
			
		</div>

		
		<div class="modal-footer">
			<button class="btn primary" data-bind="click: function(){ VM.InputVM().save_element()}, enable:  VM.InputVM().default_action.goto()&&VM.InputVM().button_text(), css:{'disabled': !(VM.InputVM().default_action.goto()&&VM.InputVM().button_text())}">
				<span class="capitalized" data-bind= "visible: current_input_verb()=='add'">Add &amp; </span>Save Your <span class="capitalized" data-bind= "text: VM.InputVM().type">
			</button>
			<a href="" class="btn secondary closer">Cancel</a>
		</div>
	</div> 
</div> {# /#addExternalMediaModal #}

{%endblock%}
